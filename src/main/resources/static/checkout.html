<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结账</title>
    <!-- CSS only -->
    <link rel="stylesheet" type="text/css" href="/css/common.css">

    <link  rel="stylesheet" href="/css/checkout.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"
</head>
<body>
<header>
    <font class="text-primary">当前用户:&nbsp;</font>
    <a class="text-primary" id="userName"></a>
    <div class="header_right">
        <input id="inputSearch" placeholder="输入搜索" maxlength="30" class="form-control"
               style="display: inline-block; width: 150px;">
        <a href="/orders" class="btn btn-link">订单</a>
        <a href="/cart" class="btn btn-link">购物车</a>
    </div>
</header>
<div class="cart_index">
    <div >
        商品图片
    </div>
    <div>
        商品名
    </div>
    <div >
        单价与数量
    </div>
    <div >
        总额
    </div>
</div>
<div id="list-goods"></div>
<div class="other">
    <div class="input-group mb-3">
        <div class="input-group-prepend">
            <label class="input-group-text" for="address">收货地址</label>
            <select class="custom-select" id="address">
                <option selected value="-1">Choose...</option>
            </select>
            总金额：<span id="total-price"></span>
            <button class="btn btn-primary" onclick="pay()">付款</button>
        </div>

    </div>
</div>


<footer>

    Copyright&nbsp;&copy;&nbsp;2020&nbsp;&nbsp;ZYL团队&nbsp;版权所有

</footer>
<!-- JS, Popper.js, and jQuery -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin="anonymous"></script>
<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="/js/commen.js"></script>

<script src="/js/checkout.js"></script>
<script>
    function pay(){
        // 先设置好地址再付款
        let aid = parseInt($("#address").val());
       if(aid==-1){
            alert("请选择收货地址");
            return;
        }
        $.ajax({
            url: `/order/${orderId}/address`,
            method: "PUT",
            dataType: "json",
            mimeType: "text/plain",
            data:{
                aid:aid
            },
            success: function(data){
                if(data.success){
                    location.href = `/pay/${orderId}`;
                } else {
                    alert("服务器异常")
                }
            },
            error: function(){
                alert("网络异常");
            }
        })
    }
    $(function () {
        let gl = new Checkout();
        $.post(`/order/${orderId}/items`, function(data){
            console.log(data);
            gl.goods = [];
            for(let i of data){
                gl.goods.push(new Good(i.gid, i.number));
            }
            gl.render($("#list-goods")[0]);
        }, "json");
        $.get(`/user/addresses`, function(data){
            console.log(data);
            let str = "";
            for(let i of data){
                str += /*html*/`
                        <option value="${i.aid}">${i.address}</option>
                    `;
            }
            $("#address").append($(str));
        }, "json");
        getUserName();
    })
</script>

</body>
</html>