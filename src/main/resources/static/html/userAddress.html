<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>表单验证</title>
    <link rel="stylesheet" href="../css/address.css">

</head>

<body>
<div>
    <table class="table table-striped">
        <caption>添加地址</caption>
        <thead>
        <tr>
            <th>省份</th>
            <th>城市</th>
            <th>地区</th>
            <th>具体街道</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody class="mtbody">
        <tr>
            <td>
                <select id="province">
                    <option>-请选择-</option>
                </select>
                <span class="mspan" id="provinceTip"></span>
            </td>
            <td>
                <select id="city">
                    <option>-请选择-</option>
                </select>
                <span class="mspan" id="cityTip"></span>
            </td>

            <td>
                <select id="area">
                    <option>-请选择-</option>
                </select>
                <span class="mspan" id="areaTip"></span>
            </td>
            <td>
                <input id="detailAddr">
                <span class="mspan" id="detailAddrTip"></span>
            </td>
            <td>
                <button class="btn btn-primary" onclick="addAddr()">添加</button>
            </td>
        </tr>
        </tbody>
    </table>


    <table class="table table-striped">
        <caption>已有地址</caption>
        <thead>
        <tr>
            <th>地名</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody class="mtbody">

        </tbody>
    </table>

</div>
<script src="../js/mcity.js"></script>

<script src="../js/checkUtil.js"></script>
<script src="../js/userInfo.js"></script>
<script>
    function addAddr(){
        if ($("#province").val() === "-请选择-") {
            fnError("provinceTip", "请选择");
            return;
        } else {
            fnSuccess("provinceTip");
        }
        if ($("#city").val() === "-请选择-") {
            fnError("cityTip", "请选择");
            return;
        } else {
            fnSuccess("cityTip");
        }
        if ($("#area").val() === "-请选择-") {
            fnError("areaTip", "请选择");
            return;
        } else {
            fnSuccess("areaTip");
        }
        if ($("#area").val() === "") {
            fnError("detailAddrTip", "请输入");
            return;
        } else {
            fnSuccess("detailAddrTip");
        }
        let address = $("#province").val()+$("#city").val()+$("#area").val()+$("#detailAddr").val();
        $.ajax({url:"/user/addUserAddress",type:"post",data:{address:address},
            success:function (data) {
                if(data.success) {
                    getAddr();

                    $("#province").val("-请选择-");
                    $("#city").val("-请选择-");
                    $("#area").val("-请选择-");

                }
            },
            error:function (data) {
                alert(data.msg);
            },dataType: "json"
        });
    }
    function deleteAddress(val) {
        let flag = confirm("确定删除此地址吗？");
        if(flag){
            $.ajax({url:"/user/updateUserAddress",type:"post",data:{aid:parseInt(val)},
                success:function (data) {
                    if(data.success) {
                        getAddr();
                    }
                },
                error:function (data) {
                    alert(data.msg);
                },dataType: "json"
            });
        }
    }
    function setAddressDefault(val) {
        $.ajax({url:"/user/updateUserAddressDefault",type:"post",data:{aid:parseInt(val)},
            success:function (data) {
                if(data.success) {
                    getAddr();
                }
            },
            error:function (data) {
                alert(data.msg);
            },dataType: "json"
        });
    }
    function getAddr(){
        $(".mtbody:last").html("");
        $.ajax({url:"/user/addresses",success:function(data){
            if(data.success){
                $.each(data.data,function (index,item) {
                    let tr = document.createElement("tr");
                    let str = "";
                    str += /*html*/`<td>${item.address}</td>
                      <td><input type="button" value="移除" onclick="deleteAddress(${item.aid})" class="btn btn-danger"></td>
                  `
                    str += item.flag=="0"?'<td><input type="button" value="设置为默认" onclick="setAddressDefault('+item.aid+')" class="btn btn-primary"></td>':'<td>当前默认</td>';
                    tr.innerHTML = str;
                    $(".mtbody:last").append(tr);
                })
            }else{
                alert(data.msg);
            }
            },
            error:function(data){

            },
            dataType:"json"});
    }
    $(function () {
        addrInit();
        getAddr();
    })
</script>
</body>

</html>