<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>商品详情</title>
    <link rel="short icon" href="../images/logo.png" type="image/x-icon">

    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link href="../css/buy.css" rel="stylesheet">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"
</head>
<body>
<header>
    <a class="text-primary" id="userName"></a>
    <div class="header_right">
        <input id="inputSearch" placeholder="输入搜索" maxlength="30" class="form-control"
               style="display: inline-block; width: 150px;">
        <a href="/orders" class="btn btn-link">订单</a>
        <a href="/cart" class="btn btn-link">购物车</a>
        <a href="/user" class="btn btn-link">个人中心</a>
        <a href="/home" class="btn btn-link">首页</a>

    </div>
</header>
<div class="goods">
    <div id="carousel" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner" id="imgs">
        </div>
        <a class="left carousel-control" href="#carousel" role="button" data-slide="prev">
            <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="right carousel-control" href="#carousel" role="button" data-slide="next">
            <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>
    <div class="goods_info">
        <div><h3 id="goodsname" class="goods_name"></h3></div>
        <div class="goods_price">价格：<span id="goodsprice" ></span> </div>
        <div class="goods_amount">数量： <input onChange="check(this.value)" type="number" min="1" value="1" id="inputGoodsNumber"></div>
        <div class="goods_store">库存:&nbsp;&nbsp;<span id="store"></span>件</div>
        <div class="goods_money">总额:&nbsp;&nbsp;<span id="amount"></span></div>
        <div class="goods_pay">
            <button class="btn btn-primary" style="font-size: 15px" id="btnJoinShoppingCart"></button>
            <span id="shoppingTip" style="width: 100px;height: 30px">&nbsp;</span>
            <button class="btn btn-primary" style="font-size: 15px"  onclick="buyGoods(goodsId)">立即购买</button>
        </div>
    </div>
</div>
<div class="others">
    <ul class="nav nav-tabs myTab">
        <li class="active" >
            <a href="#goodsDescription" data-toggle="tab" >
                商品详情
            </a>
        </li>
        <li>
            <a href="#goodsComments" data-toggle="tab">
                商品评价
            </a>
        </li>

    </ul>
    <div id="myTabContent" class="tab-content">
        <div class="tab-pane fade in active" id="goodsDescription">

        </div>
        <div class="tab-pane fade" id="goodsComments">

        </div>
    </div>


</div>

<footer>
    Copyright&nbsp;&copy;&nbsp;2020&nbsp;&nbsp;ZYL团队&nbsp;版权所有
</footer>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin="anonymous"></script>
<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="../js/order.js"></script>
<script src="../js/search_loginout.js"></script>

<script src="../js/commen.js"></script>

<script>

    const goodsId = window.location.href.substring(window.location.href.lastIndexOf("/") + 1);


    /*
    *   核对输入的值
    * */
    function check(num) {
        let price = parseInt($("#goodsprice").text().replace("¥",""));
        $("#amount").text(num * price);
    }


    /**
     * 购买商品
     */
    function buyGoods(goodsId) {
        let date = new Date();
        let oid = ""+date.getHours()+date.getMinutes()+date.getSeconds()+date.getMilliseconds();

        $.ajax({
                type: 'PUT',
                url: "/order",
                data:
                    JSON.stringify({items:[{
                        gid: goodsId, number: $("#inputGoodsNumber").val(), price:$("#goodsprice").text().replace("¥","")
                    }],amount:parseFloat($("#amount").text()),oid:oid}),
                contentType: "application/json",
                dataType: "json",
                success:
                    function (msg) {
                        if (msg.success) {
                            window.location.href = "/checkout/"+oid;
                        } else {
                            if (msg.msg === "未登录") {
                                alert("请登录!!!");
                                window.location.href = "../index";
                            }
                        }
                    }

            }
        )
        ;
    }
    window.onload = function () {
        /**
         * 加载数据
         */
        getUserName();

        $.ajax({
            type: 'GET',
            url: "getGoodsDetails/shopping/" + goodsId,
            success: function (msg) {
                if (msg.success) {
                    if(msg.data.exist){
                        $("#btnJoinShoppingCart").text("查看购物车").bind("click",function () {
                            location.href='/cart';
                        });
                    }else{
                        $("#btnJoinShoppingCart").text("加入购物车").bind("click",function(){
                            joinShoppingCart(goodsId);
                        });
                    }
                    $("#imgs").empty();
                    let images = msg.data.goods["images"].split(",");
                    for (let i = 0, len = images.length; i < len; i++) {
                        $("#imgs").append("<div class='item'><img class='goods_img'  src='../"  + images[i] + "' ></div>");
                    }
                    $("#imgs .item:first").addClass('active');
                    $("#goodsname").text(msg.data.goods["name"])
                    $("#amount").text(msg.data.goods["price"]);
                    $("#goodsprice").html("&yen;"+msg.data.goods["price"]);
                    $("#store").text(msg.data.goods["store"]);
                    $("#inputGoodsNumber").attr("max",msg.data.goods["store"]);
                    $("#goodsDescription").html(msg.data.goods["description"]);
                    $("#goodsComments").empty();
                    for (let i = 0, len = msg.data.goods["comments"].length; i < len; i++) {
                        let comment = msg.data.goods["comments"][i];
                        let s = "<span>" + comment["person"] + "&nbsp;：&nbsp;" + comment["details"] + "&nbsp;&nbsp;" + comment["dateTime"].substr(0,10) + "</span><br>";
                        $("#goodsComments").append(s);
                    }
                }
            }
        });
    }



</script>
</body>
</html>

