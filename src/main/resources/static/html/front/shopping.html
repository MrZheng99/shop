<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>商品详情</title>
    <link href="../../css/bootstrap.css" rel="stylesheet">
    <link href="../../css/buy.css" rel="stylesheet">
    <link href="../../css/font-awesome.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../../css/bootstrap-3.3.7-dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

</head>

<body>
<div class="popover-header" style="height:40px;">
    <a class="text-primary" id="userName" style="font-size:16px"></a>
    <a href="cart" class="head-cart"><button id="search" value="购物车" class="btn btn-primary">购物车</button></a>
</div>
<div class="bg-secondary">

</div>

<div class="goods">
    <div id="divimg" class='goods_div' >
    <ul id="img_list">
       
    </ul>
     <ol id="button_list"> <!-- 轮播按钮 -->
                <li class="first-li" id="olli1">0</li>
                <li id="olli2">1</li>
                <li id="olli3">2</li>
            </ol>
    </div>
    <div class="goods_info">
            <h3 id="goodsname" class="goods_name"></h3>
            <div class="goods_price">价格：<span id="goodsprice" ></span> </div>
            <div class="goods_amount">数量： <input onChange="check(this.value)" type="number" value="1" id="inputGoodsNumber"></div>
            <div class="goods_store">库存:<span id="store"></span>件</div>
            <div class="goods_money">总额:<span id="amount"></span></div>
            <div class="goods_pay">
            <button class="btn-success" id="btnJoinShoppingCart" onclick="joinShoppingCart()">加入购物车</button>
            <span id="shoppingTip" style="width: 100px;height: 30px">&nbsp;</span>
            <button class="btn-success"  onclick="buyGoods()">立即购买</button>
            </div>
    </div>
</div>

<div class="others">
<ul id="myTab" class="nav nav-tabs">
	<li class="active">
		<a href="#home" data-toggle="tab">
			 商品详情
		</a>
	</li>
	<li><a href="#ios" data-toggle="tab">商品评价</a></li>

</ul>
<div id="myTabContent" class="tab-content">
	<div class="tab-pane fade in active" id="home">
		<div id="goodsDescription" class="goods_des">
		
         </div>
	</div>
	<div class="tab-pane fade" id="ios">
		   <div id="goodsComments" class="goods_Com" >
 
    </div>
	</div>
</div>

   
</div>

<div class="modal-footer" >
    Copyright&nbsp;&copy;&nbsp;2020&nbsp;&nbsp;ZYL团队&nbsp;版权所有
</div>


</body>
<script src="../../js/jquery.js"></script>
<script src="../../js/order.js"></script>


<script>

    const goodsId = window.location.href.substring(window.location.href.lastIndexOf("/") + 1);
    /**
     * 查询用户名
     */
    $.ajax({
        type: 'GET',
        url: "queryName",
        success: function (msg) {
            if (msg.success) {
                $("#userName").text("当前用户：" + msg.data);
            } else {
                $("#userName").text('未登录');
            }
        }

    });

    /*
    *   核对输入的值
    * */
    function check(num) {
        let store = $("#store").text();
        let price = $("#goodsprice").text();
        if (num > store) {
            $("#inputGoodsNumber").val(store);
            $("#amount").text(store * price);
            return;
        }
        if (num < 0) {
            $("#inputGoodsNumber").val(0);
            $("#amount").text(0);
            return;
        }
        $("#amount").text(num * price);

    }

    /**
     * 加入购物车
     */
    function joinShoppingCart() {
        $.ajax({
            type: 'GET',
            url: "addGoods2ShoppingCart/" + goodsId,
            success: function (msg) {
                if (msg.success) {
                    $("#shoppingTip").text(msg.data);
                    $("btnJoinShoppingCart").attr("disabled", "disabled");
                } else {
                    if (msg.data === "未登录") {
                        alert("请登录!!!");
                        window.location.href = "../index";
                    }
                }
            }

        });
    }

    /**
     * 购买商品
     */
    function buyGoods() {

        $.ajax({
                type: 'PUT',
                url: "../order",
                data: JSON.stringify([{
                        gid: goodsId, number: $("#inputGoodsNumber").val(), price: $("#amount").text()
                    }
                    ]
                ),
                contentType: "application/json",
                dataType:
                    "json",
                success:

                    function (msg) {
                        if (msg.success) {
                            window.location.href = "/orders";
                        } else {
                            if (msg.msg === "未登录") {
                                alert("请登录!!!");
                                window.location.href = "../index";
                            }
                        }
                    }

            }
        )
        ;
    }

    window.onload = function () {
        /**
         * 加载数据
         */
        $.ajax({
            type: 'GET',
            url: "getGoodsDetails/" + goodsId,
            success: function (msg) {
                if (msg.success) {
                    $("#divimg").empty();
                    for (let i = 0, len = msg.data["imgUrls"].length; i < len; i++) {
                    	let alt = i;
                        let img = "<li ><img class='goodsimg'  src='../"  + msg.data["imgUrls"][i] + "' alt=" + (i) + "></li>"
                        $("#divimg").append(img);
                    }
                    $("#goodsprice").text(msg.data["price"]);
                    $("#store").text(msg.data["store"]);
                    $("#goodsDescription").text("描述：" + msg.data["description"]);
                    $("#goodsComments").empty();
                    for (let i = 0, len = msg.data["comments"].length; i < len; i++) {
                        let comment = msg.data["comments"][i];
                        let s = "<span>评论人：" + comment["person"] + "评论详情：" + comment["details"] + "评论时间：" + comment["dateTime"] + "</span><br>";
                        console.log(s);
                        $("#goodsComments").append(s);

                    }

                }
            }
        });
        auto();
    }

    function auto() {
        var goods_div = document.getElementById("divimg"),
            img_list = document.getElementById("img_list"),
            button_list = document.getElementById("button_list").getElementsByTagName("li"),
            index = 0,
            timer = null;
            //初始化
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
    		
       
            // 自动切换
            timer = setInterval(autoPlay, 1000);
       
            // 调用自动播放函数
        function autoPlay() {
                index++;
                if (index >= button_list.length) {
                    index = 0;
                }
                imgChange(index);
         }
        
        function imgChange(buttonIndex) {
            for (let i = 0; i < button_list.length; i++) {
                button_list[i].className="";
            }
            button_list[buttonIndex].className = "first-li";//按钮样式切换
            img_list.style.marginLeft = -1000 * buttonIndex + "px";
            index = buttonIndex;
        }
        //鼠标接触div
      
       
        
    }
</script>
</html>

