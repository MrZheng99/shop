<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>商品详情</title>
    <link href="../../css/bootstrap.css" rel="stylesheet">
    <link href="../../css/buy.css" rel="stylesheet">
    <link href="../../css/font-awesome.css" rel="stylesheet">

</head>

<body>
<div class="popover-header">
    <a class="text-primary" id="userName">当前用户:</a>
    <label class="float-right">
        <a href="cart"><input type="button" value="购物车"></a>
    </label>
</div>
<div class="bg-secondary">

</div>


<div class="goods_info">
    <img class="goods_img" id="goodsimg">
    <h3 id="goodsname"></h3>
    价格：<span id="goodsprice"></span>
    数量： <input onChange="check()" type="number" value="1" id="inputGoodsNumber">
    库存:<span id="store"></span>件
    <button class="text-dark" id="btnJoinShoppingCart" onclick="joinShoppingCart()">加入购物车</button>
    <span id="shoppingTip" style="width: 100px;height: 30px"></span>
    <button class="text-dark" onclick="buyGoods()">立即购买</button>
</div>
</div>


<div id="goodsDescription">

</div>
<div id="goodsComments" style="width:100%;height:300px">

</div>

<div class="modal-footer">
    Copyright&nbsp;&copy;&nbsp;2020&nbsp;&nbsp;ZYL团队&nbsp;版权所有
</div>


</body>
<script src="../../js/jquery.js"></script>
<script src="../../js/order.js"></script>


<script>
    const goodsId = window.location.href.substring(window.location.href.lastIndexOf("/") + 1);
    $.ajax({
        type: 'GET',
        url: "queryName",
        success: function (msg) {
            if (msg.success) {
                $("#userName").text("当前用户：" + msg.data);
            } else {
                $("#userName").text('未登录');
            }
        }

    });

    function joinShoppingCart() {
        $.ajax({
            type: 'GET',
            url: "addGoods2ShoppingCart/" + goodsId,
            success: function (msg) {
                if (msg.success) {
                    $("#shoppingTip").text(msg.data);
                    $("btnJoinShoppingCart").attr("disabled", "disabled");
                } else {
                    if (msg.data === "未登录") {
                        alert("请登录!!!");
                        window.location.href = "../index";
                    }
                }
            }

        });
    }

    function buyGoods() {

        $.ajax({
                type: 'PUT',
                url: "../order",
                data: JSON.stringify([{
                        gid: goodsId, number: $("#inputGoodsNumber").val(), price: $("#goodsprice").text()
                    }
                    ]
                ),
                contentType: "application/json",
                dataType:
                    "json",
                success:

                    function (msg) {
                        if (msg.success) {
                            window.location.href = "/orders";
                        } else {
                            if (msg.msg === "未登录") {
                                alert("请登录!!!");
                                window.location.href = "../index";
                            }
                        }
                    }

            }
        )
        ;
    }

    window.onload = function () {

        $.ajax({
            type: 'GET',
            url: "getGoodsDetails/" + goodsId,
            success: function (msg) {
                if (msg.success) {
                    $("#goodsimg").attr("src", "../" + msg.data["imgUrl"]);
                    $("#goodsprice").text(msg.data["price"]);
                    $("#store").text(msg.data["store"]);
                    $("#goodsDescription").text("描述：" + msg.data["description"]);
                    $("#goodsComments").empty();
                    for (let i = 0, len = msg.data["comments"].length; i < len; i++) {
                        let comment = msg.data["comments"][i];
                        let s = "<span>评论人：" + comment["person"] + "评论详情：" + comment["details"] + "评论时间：" + comment["dateTime"] + "</span><br>";
                        console.log(s);
                        $("#goodsComments").append(s);

                    }

                }
            }
        });
    }


</script>
</html>

