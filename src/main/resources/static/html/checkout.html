<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结账</title>
    <link rel="short icon" href="../images/logo.png" type="image/x-icon">

    <!-- CSS only -->
    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link  rel="stylesheet" href="../css/address.css">

    <link  rel="stylesheet" href="../css/checkout.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"
</head>
<body>
<header>
    <a id="userName"></a>
    <div class="header_right">
        <input id="inputSearch" placeholder="输入搜索" maxlength="30" class="form-control"
               style="display: inline-block; width: 250px;">
        <a href="/orders" class="btn btn-link">订单</a>
        <a href="/cart" class="btn btn-link">购物车</a>
        <a href="/user" class="btn btn-link">个人中心</a>
        <a href="/home" class="btn btn-link">首页</a>


    </div>
</header>

<table class="table table-striped">
    <caption>订单付款</caption>
    <thead>
    <tr>
        <th> 商品图片</th>
        <th>商品名称</th>
        <th>单价与数量</th>
        <th>总额</th>
    </tr>
    </thead>
    <tbody class="mtbody">

    </tbody>
</table>
<div class="other">
    <div class="input-group mb-3">
        <div class="input-group-prepend" style="margin-top: 20px;">
            <label class="input-group-text" for="address">收货地址</label>
            <select class="custom-select" id="address">
            </select>
        </div>
        <div class="input-group-prepend" style="text-align: center;margin-top: 20px">
        总金额：<span id="total-price" style="color: red;font-size: large;font-weight: bold;"></span>
            <button style="margin-left: 10px" class="btn btn-primary" onclick="pay()">付款</button>
        </div>
    </div>
</div>


<footer>

    Copyright&nbsp;&copy;&nbsp;2020&nbsp;&nbsp;ZJ&nbsp;版权所有

</footer>
<!-- JS, Popper.js, and jQuery -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" crossorigin="anonymous"></script>
<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="../js/commen.js"></script>

<script src="../js/checkout.js"></script>
<script>
    function pay(){
        // 先设置好地址再付款
        let aid = parseInt($("#address").val());
       if(aid==-1){
            //alert("请选择收货地址");
            return;
        }
        $.ajax({
            url: `/order/${orderId}/address`,
            method: "PUT",
            dataType: "json",
            mimeType: "text/plain",
            data:{
                aid:aid
            },
            success: function(data){
                if(data.success){
                    location.href = `/aliPay/${orderId}`;
                } else {
                    alert("服务器异常")
                }
            },
            error: function(){
                alert("网络异常");
            }
        })
    }
    $(function () {
        let gl = new Checkout();
        $.post(`/order/${orderId}/items`, function(data){
            console.log(data);
            gl.goods = [];
            for(let i of data){
                gl.goods.push(new Good(i.gid, i.number));
            }
            gl.render($(".mtbody:first"));
        }, "json");
        $.get(`/user/addresses`, function(data){
            console.log(data);
            let str = "";
            for(let i of data.data){
                if(i.flag=="0"){
                    str += /*html*/`
                        <option value="${i.aid}" >${i.address}</option>
                    `;}
                else{
                    str += /*html*/`
                        <option value="${i.aid}" selected="selected">${i.address}--默认</option>
                    `;
                }
            }
            $("#address").append($(str));
        }, "json");
        getUserName();
        addSearch();
    })
</script>

</body>
</html>